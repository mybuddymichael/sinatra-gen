#!/usr/bin/env bash

set -e

red=$(printf "\033[31m")
clr=$(printf "\033[m")

help() {
  cat << HELP

  USAGE: sinatra-gen [options] PROJECT_NAME

  OPTIONS:
    -h, --help      Display this help.
    -d, --dry-run   Don't actually create any files.

HELP
}

app_rb() {
  cat << APP
require 'bundler/setup'
Bundler.require

class App < Sinatra::Base

  # AssetPack
  register Sinatra::AssetPack

  assets do
    serve '/js', from: '/scripts'
    serve '/css', from: '/styles'
    js :app, '/js/app.js', [
      '**/*.js' ]
    css :app, '/css/app.css' [
      '**/*.css' ]
  end

  # Mustache
  register Mustache::Sinatra
  set :mustache, {
    views: './views/',
    templates: './templates/' }
  require_relative 'views/layout'

  get '/' do
    mustache :index
  end

end
APP
}

create_project() {
  mkdir $1
  app_rb > $1/app.rb
}

if [[ -z "$*" ]]; then
  help
  exit
fi

while [[ "$1" == -* ]]; do
  case "$1" in
    -h|--help)
      help
      exit;;
    -*)
      echo ""
      echo "  ${red}ERROR: UNKNOWN ARGUMENT ($1)${clr}" >&2
      help
      exit 1;;
  esac
done

if [[ -d $1 ]]; then
  echo ""
  echo "  ${red}ERROR: DIRECTORY $1 ALREADY EXISTS${clr}" >&2
  help
  exit 1
else
  create_project $1
  exit 0
fi
